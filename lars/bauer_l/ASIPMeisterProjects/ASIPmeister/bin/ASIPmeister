#!/bin/sh
#
# ASIP Meister 1.1 start up script
#
# Copyright 2001 PEAS project.  All rights reserved.

if [ -f /tmp/fhm_server.log ]; then
  echo
  echo "--- ERROR: It seems another user is currently using ASIP Meister on this computer!"
  echo "---        The file /tmp/fhm_server.log is existing and HAS TO be deleted before"
  echo "           ASIP Meister can be started!"
  echo "           You can delete this file using the "delfhm" command"
  echo
  exit
fi

if [ -f /tmp/fhm_client.log ]; then
  echo
  echo "--- ERROR: It seems another user is currently using ASIP Meister on this computer!"
  echo "---        The file /tmp/fhm_client.log is existing and HAS TO be deleted before"
  echo "           ASIP Meister can be started!"
  echo "           You can delete this file using the "delfhm" command"
  echo
  exit
fi

#ASIP_MEISTER_HOME=/Software/epp/ASIPmeister
ASIP_MEISTER_HOME=/home/bauer_l/ASIPMeisterProjects/ASIPmeister
OLD_JAVA_HOME=/Software/epp/SunJava2-1.3.1/jdk1.3.1_12/bin 
echo $LD_LIBRARY_PATH

PATH=${ASIP_MEISTER_HOME}/bin:${OLD_JAVA_HOME}:${PATH}:/usr/bin:/sbin:/bin
# :/usr/lib/j2re1.3-sun

# default setting
if [ -f $HOME/.ASIPmeister.ini ]; then
	preference=$HOME/.ASIPmeister.ini
else
	preference=${ASIP_MEISTER_HOME}/etc/.ASIPmeister.ini
fi

#log_dir=peas3
log_dir=meister
if [ "$ASIP_MEISTER_LOG"x = x ]; then
#	ASIP_MEISTER_LOG=${log_dir}/peaslog.txt
	ASIP_MEISTER_LOG=${log_dir}/meisterlog.txt
fi

# setup for sub-systems

#PEAS3_HOME=$ASIP_MEISTER_HOME
. $ASIP_MEISTER_HOME/etc/entry.setup.sh
. $ASIP_MEISTER_HOME/etc/fhm.setup.sh
. $ASIP_MEISTER_HOME/etc/estimate.setup.sh
#. $ASIP_MEISTER_HOME/etc/rtgen.setup.sh

# CES added - setup environment
. $ASIP_MEISTER_HOME/etc/asipmeister_epp.setup 
#echo ASIPmeister needs Java 1.3.1 
$OLD_JAVA_HOME/java -version

# check Java library
lib_dir=${ASIP_MEISTER_HOME}/lib
# if [ ! -f $lib_dir/ASIPmeister.jar ]; then
# 	echo "Can't read $lib_dir/ASIPmeister.jar"
# 	exit 15
# fi

# check the preference file
if [ ! -f $preference ]; then
	echo "The Preference file not found."
	exit 20
fi

# check log directory
if [ ! -d $log_dir ]; then
 	if mkdir $log_dir; then
 		true
 	else
		echo "Can't make ${log_dir} directory in current directory"; \
 		exit 30
 	fi
fi

# start ASIP Meister

pid=`pidof fhm_server`
if [ "$pid"x != x ]; then
        kill $pid
fi

fhm_server fhm > /tmp/fhm_server.log 2>&1 &

$OLD_JAVA_HOME/java -classpath ${lib_dir}/ASIPmeister.jar peas3.app -p ${preference} \
    -s $ASIP_MEISTER_HOME -l $ASIP_MEISTER_LOG $*

kill `pidof fhm_server`
rm -f /tmp/fhm_server.log
rm -f /tmp/fhm_client.log

